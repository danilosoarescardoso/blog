<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Danilo Soares Frois Cardoso">


    <meta name="subtitle" content="Desenvolvimento Web e amenidades">


    <meta name="description" content="Aqui falo sobre tecnologia e muitas amenidades.">





<title>Usando Cache em APIs: Exemplo Prático | Blog do Frois</title>



    <link rel="icon" href="/favicon.ico">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/menu.js"></script>
    










  <meta name="generator" content="Hexo 5.4.2"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            Blog do Frois.
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">Posts</a>
              </li> 
                   
          
          
        </ul>
      </nav>
    </div>
  </div>
</div>
<script src="/js/menu.js"></script>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
                
                    <span class="post-tag">
                        <a href="/tags/apis/">
                            apis
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/arquitetura/">
                            arquitetura
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/cache/">
                            cache
                        </a>
                    </span>    
                           
            
        </div>
        <div class="post-title">
            
            
                Usando Cache em APIs: Exemplo Prático
            
            
        </div>
        <span class="post-date">
            abr 18, 2023
        </span>
    </div>
    <div class="post-img">
        
            <div class="h-line-primary"></div>
              
    </div>
</div>
    <div class="post-content">
    <p>Recentemente fiz dois posts sobre <a href="https://danilocardoso.dev/blog/quando-usar-cache-apis/">quando usar</a> e <a href="https://danilocardoso.dev/blog/quando-nao-usar-cache-apis/">quando não usar</a> cache em APIs. No texto de hoje mostro de forma simples como o cache pode ser usado em uma API. O link para o repositório pode ser <a target="_blank" rel="noopener" href="https://github.com/danilosoarescardoso/cache-python-example">encontrado aqui</a>.</p>
<p>Vamos lá!</p>
<h2 id="Premissas-da-API"><a href="#Premissas-da-API" class="headerlink" title="Premissas da API"></a>Premissas da API</h2><p>Para o exemplo,criei uma API em Python utilizando a biblioteca Flask, que permite a criação de endpoints de forma bastante simples. A API tem duas rotas principais, uma para obter todos os produtos e outra para obter um produto específico com base em seu ID.</p>
<h2 id="Dependencias"><a href="#Dependencias" class="headerlink" title="Dependências"></a>Dependências</h2><p>Utilizei as seguintes bibliotecas:</p>
<ul>
<li><strong>Flask</strong>: framework web em Python usado para criar aplicativos web e APIs RESTful.</li>
<li><strong>jsonify</strong>: é uma função do Flask que transforma objetos Python em JSON para que possam ser retornados como uma resposta HTTP.</li>
<li><strong>Flask-Caching</strong>: é uma extensão Flask que fornece recursos de armazenamento em cache para o aplicativo Flask.</li>
<li><strong>time</strong>: é um módulo Python que fornece funções relacionadas ao tempo, como sleep, que é usada neste exemplo para simular um acesso a um banco de dados adicionando um atraso em algumas das funções.</li>
</ul>
<h2 id="Utilizando-o-cache-nos-endpoints"><a href="#Utilizando-o-cache-nos-endpoints" class="headerlink" title="Utilizando o cache nos endpoints"></a>Utilizando o cache nos endpoints</h2><p>No endpoint que lista produtos por ID inclui um cache de 10 segundos. Isso significa que quando uma chamada é feita, a informação será buscada no banco de dados. Nas próximas chamadas que ocorrerem dentro de 10 segundos, a resposta enviada será aquela armazenada em cache, logo não haverá o processamento da função que vai até o banco de dados.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Return a product by id</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/products/&lt;int:id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@cache.cached(<span class="params">timeout=<span class="number">10</span></span>)  </span><span class="comment"># 10 seconds of cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_product</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(find_product(<span class="built_in">id</span>))</span><br></pre></td></tr></table></figure>

<p>Para simplificar o teste, a função que retorna o produto não possui acesso a um banco de dados real, mas sim um atraso de 5 segundos para simular esse acesso, buscando os dados em um <em>array</em>. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find product by id</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_product</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Adding a simple delay to simulate an access to a database</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> product <span class="keyword">in</span> products:</span><br><span class="line">        <span class="keyword">if</span> product[<span class="string">&#x27;id&#x27;</span>] == <span class="built_in">id</span>:</span><br><span class="line">            <span class="keyword">return</span> product</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>Logo, a primeira chamada vai demorar mais de 5 segundos e as demais serão mais rápidas, dentro dos 10 segundos de cache.</p>
<h3 id="Configuracao-do-cache"><a href="#Configuracao-do-cache" class="headerlink" title="Configuração do cache"></a>Configuração do cache</h3><p>Para usar o cache na aplicação, utilizei os seguintes parâmetros de inicialização:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">cache = Cache(app, config=&#123;<span class="string">&#x27;CACHE_TYPE&#x27;</span>: <span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;CACHE_REDIS_URL&#x27;</span>: <span class="string">&#x27;redis://localhost:6379&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>Nas parametrizações acima, estou utilizando o Redis como banco de dados de cache. Para instalar o Redis, basta seguir as instruções <a target="_blank" rel="noopener" href="https://redis.io/topics/quickstart">deste link</a> e subir a sua instância. Em <strong>CACHE_TYPE</strong> é definido o tipo de cache que será utilizado pela aplicação. Os modos disponíveis são estes:</p>
<ul>
<li><strong>simple</strong>: cache simples em memória para aplicações de processo único. Não recomendado para uso em produção ou ambientes com vários processos.</li>
<li><strong>filesystem</strong>: cache que armazena dados no sistema de arquivos local. Adequado para implantações de servidor único, onde o cache não precisa ser compartilhado entre vários processos ou servidores.</li>
<li><strong>redis</strong>: Um cache que usa o Redis como backend. Adequado para implantações mais complexas ou quando você precisa de um cache distribuído que pode ser compartilhado entre vários processos ou servidores.</li>
<li><strong>memcached</strong>: Um cache que usa o Memcached como backend. Adequado para cache distribuído em vários servidores.</li>
<li><strong>saslmemcached</strong>: Um cache Memcached que suporta o mecanismo de autenticação SASL (Simple Authentication and Security Layer).</li>
<li><strong>gaememcached</strong>: Um cache que usa o serviço Memcached do Google App Engine. Adequado para aplicativos em execução no Google App Engine.</li>
<li><strong>uwsgi</strong>: Um cache que usa o framework de cache do uWSGI. Adequado para implantações usando uWSGI como servidor de aplicativos.</li>
</ul>
<p>No caso deixei como Redis por ser a configuração <em>default</em> da biblioteca.</p>
<h2 id="Testando-a-API-e-resultados"><a href="#Testando-a-API-e-resultados" class="headerlink" title="Testando a API e resultados"></a>Testando a API e resultados</h2><p>Utilizando o Postman, fiz algumas chamadas sem o cache e posteriormente com o cache. Podemos ver, no primeiro resultado, que a resposta demorou 5 segundos para ser retornada. Nas próximas chamadas, a resposta foi retornada em menos de 1 segundo, pois o cache foi utilizado.</p>
<img src="/blog/exemplo-cache-apis/request-without-cache.png" class="">

<p>Imagem 1 - Resposta sem cache</p>
<hr>
<img src="/blog/exemplo-cache-apis/request-with-cache.png" class="">

<p>Imagem 2 - Resposta com cache</p>
<hr>
<p>Fiz o mesmo teste com o endpoint que retorna todos os produtos, obtendo os seguintes resultados:</p>
<img src="/blog/exemplo-cache-apis/request-without-cache-2.png" class="">

<p>Imagem 3 - Resposta sem cache</p>
<hr>
<img src="/blog/exemplo-cache-apis/request-with-cache-2.png" class="">

<p>Imagem 4 - Resposta com cache</p>
<h2 id="Consideracoes"><a href="#Consideracoes" class="headerlink" title="Considerações"></a>Considerações</h2><p>Esse foi um exemplo bem simples de como cache pode ser usado em APIs. Em sistemas distribuídos, onde há uma maior complexidade técnica, pode ser necessário utilizar camadas adicionais de cache ou outras técnicas. Por isso vale a pena estudar a fundo as ferramentas que existem além do Redis e entender, no caso do Redis, como se aplicam os diferentes tipos de cache que ele implementa.</p>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
                <div class="icon arrow-left"></div>
                <div class="post-link">
                    <a href="/api-design-first-passo-a-passo/">Prev</a>
                </div>
            
        </div>
        <div class="next-item">
            
                <div class="icon arrow-right"></div>
                <div class="post-link">
                  <a href="/quando-nao-usar-cache-apis/">Next</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/zoeingwingkei/frame/">Frame</a>
                
        </div>
    </div>
</div>

    </div>

    
    

  </body>
</html>
